SET @startdate = DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 1 MONTH), '%Y-%m-01');
SET @enddate = LAST_DAY(DATE_SUB(CURDATE(), INTERVAL 1 MONTH));

SELECT @startdate,@enddate;
SELECT CASE WHEN ATV <1500 THEN 'upto 1500'
WHEN ATV BETWEEN 1500 AND 3000 THEN '1500-3000'
WHEN ATV BETWEEN 3001 AND 4500 THEN '3001-4500'
WHEN ATV BETWEEN 4501 AND 6000 THEN '4501-6000'
WHEN ATV BETWEEN 6001 AND 7500 THEN '6001-7500'
WHEN ATV BETWEEN 7501 AND 9000 THEN '7501-9000'
WHEN ATV BETWEEN 9001 AND 10500 THEN '9001-10500'
WHEN ATV BETWEEN 10501 AND 12000 THEN '10501-12000'
WHEN ATV > 12000 THEN 'more than 12000'
END AS ATV_band,COUNT(mobile)AS customers,SUM(bills) AS bills,SUM(sales) AS sales
FROM (
SELECT mobile,COUNT(DISTINCT uniquebillno) AS bills,SUM(amount) AS sales,
SUM(amount)/COUNT(DISTINCT uniquebillno) AS ATV
FROM `txn_report_accrual_redemption`
WHERE insertiondate< CURDATE()
AND txndate BETWEEN  @startdate AND @enddate
GROUP BY 1)a
GROUP BY 1
ORDER BY ATV;
